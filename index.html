<!-- 
============================================
kaerez/speedtest/index.html
============================================
* Author: Erez Kalman - KSEC
* Repo: kaerez/speedtest
* License: PolyForm Noncommercial 1.0.0 (Requires CLA)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Erez Kalman - KSEC">
    
    <!-- Security: Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>KSEC SPEED TEST</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Clean White Theme Variables */
        :root { 
            --bg: #ffffff; 
            --term: #1f2937; /* slate-800 */
            --accent: #059669; /* emerald-600 */
            --border: #e2e8f0; /* slate-200 */
        }
        body { 
            background-color: #f8fafc; /* slate-50 */
            color: var(--term); 
            font-family: 'Rajdhani', sans-serif; 
            overflow-x: hidden; 
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .tech-border { 
            background: white;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            position: relative; 
        }
        .tech-border::after { 
            content: ''; position: absolute; top: -1px; left: -1px; width: 12px; height: 12px; 
            border-top: 2px solid var(--accent); border-left: 2px solid var(--accent); 
        }
        .tech-border::before { 
            content: ''; position: absolute; bottom: -1px; right: -1px; width: 12px; height: 12px; 
            border-bottom: 2px solid var(--accent); border-right: 2px solid var(--accent); 
        }
        
        .bg-grid { 
            background-size: 40px 40px; 
            background-image: linear-gradient(to right, #00000005 1px, transparent 1px), 
                              linear-gradient(to bottom, #00000005 1px, transparent 1px); 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-grid">
    <div id="root" class="flex-grow flex flex-col relative z-10"></div>

    <script type="text/babel">
        // Security: Frame Buster
        if (window.self !== window.top) {
            try { window.top.location = window.self.location; } 
            catch (e) { document.body.innerHTML = 'Embedding not permitted.'; }
        }

        const { useState, useEffect, useRef } = React;

        // Constants & Maps
        const COLO_MAP = {
            'LHR': 'London, UK', 'MAN': 'Manchester, UK', 'AMS': 'Amsterdam, NL', 'FRA': 'Frankfurt, DE',
            'CDG': 'Paris, FR', 'IAD': 'Ashburn, VA, US', 'SJC': 'San Jose, CA, US', 'LAX': 'Los Angeles, CA, US',
            'JFK': 'New York, NY, US', 'ORD': 'Chicago, IL, US', 'DFW': 'Dallas, TX, US', 'SEA': 'Seattle, WA, US',
            'MIA': 'Miami, FL, US', 'NRT': 'Tokyo, JP', 'KIX': 'Osaka, JP', 'ICN': 'Seoul, KR',
            'SIN': 'Singapore, SG', 'HKG': 'Hong Kong, HK', 'SYD': 'Sydney, AU', 'MEL': 'Melbourne, AU',
            'BOM': 'Mumbai, IN', 'DEL': 'New Delhi, IN', 'GRU': 'Sao Paulo, BR', 'EZE': 'Buenos Aires, AR',
            'TLV': 'Tel Aviv, IL', 'DXB': 'Dubai, AE', 'JNB': 'Johannesburg, ZA', 'YYZ': 'Toronto, CA'
        };

        const getColoRegion = (code) => COLO_MAP[code] || 'Unknown Region';
        const getIpVersion = (ip) => ip.includes(':') ? 'IPv6' : 'IPv4';
        const getTimestamp = () => new Date().toISOString().replace('T', ' ').split('.')[0] + ' UTC';

        const getFlag = (cc) => {
            if (!cc || cc === 'XX') return 'ðŸŒ';
            return cc.toUpperCase().replace(/./g, char => 
                String.fromCodePoint(char.charCodeAt(0) + 127397)
            );
        }

        // --- Custom Icons ---
        const ExternalIcon = () => (
            <svg width="1.25em" height="1.25em" viewBox="0 0 33 24" fill="currentColor" className="inline-block ml-1 align-text-bottom text-emerald-500 hover:text-emerald-700 transition-colors">
                <path d="m23 0 1 1v5.56h-2V2H2v20h20v-4.55h2V23l-1 1H1l-1-1V1l1-1zm4.47 6.56-1.4 1.42L29.13 11H12.01v2h17.12l-3.06 3.02 1.4 1.42L33 12z"></path>
            </svg>
        );

        // --- UI Component: Gauge ---
        const Gauge = ({ value, label, unit, color }) => {
            const r = 70, c = 2 * Math.PI * r, max = 1000;
            const off = c - (Math.min(value, max) / max) * c;
            const strokeColor = color === 'cyan' ? '#0891b2' : '#059669';

            return (
                <div className="tech-border p-6 flex flex-col items-center justify-center w-full rounded-sm">
                    <div className="relative w-48 h-48">
                        <svg className="transform -rotate-90 w-full h-full">
                            <circle cx="96" cy="96" r={r} stroke="#f1f5f9" strokeWidth="8" fill="transparent" />
                            <circle cx="96" cy="96" r={r} stroke={strokeColor} strokeWidth="8" fill="transparent" strokeDasharray={c} strokeDashoffset={off} strokeLinecap="round" className="transition-all duration-300 ease-out" />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <span className="text-4xl font-bold mono" style={{color: strokeColor}}>{value.toFixed(1)}</span>
                            <span className="text-xs text-gray-500 font-bold tracking-widest">{unit}</span>
                        </div>
                    </div>
                    <div className="mt-2 text-slate-500 text-sm tracking-widest uppercase font-bold">{label}</div>
                </div>
            );
        };

        const StatBox = ({ icon, label, value, subValue, extraValue }) => (
            <div className="tech-border p-4 bg-white flex flex-col justify-between h-full">
                <div className="flex items-center gap-2 mb-2">
                    {icon}
                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">{label}</span>
                </div>
                <div>
                    <div className="text-xl font-bold text-slate-800 leading-tight break-words">{value}</div>
                    {subValue && <div className="text-xs text-slate-500 font-mono mt-1">{subValue}</div>}
                    {extraValue && <div className="text-xs text-slate-400 font-mono">{extraValue}</div>}
                </div>
            </div>
        );

        // --- Main Application ---
        const App = () => {
            const [status, setStatus] = useState('IDLE');
            const [data, setData] = useState({ 
                ping: 0, jitter: 0, loss: 0, down: 0, up: 0, 
                meta: { ip: '---', isp: 'Loading...', country: 'XX', asn: '---', city: '---', region: '', colo: '---' } 
            });
            const [logs, setLogs] = useState([]);
            
            useEffect(() => { log('SYSTEM READY'); }, []);
            const log = (m) => setLogs(p => [...p, `[${getTimestamp()}] > ${m}`]);

            useEffect(() => {
                fetch('/api/meta')
                    .then(r => r.json())
                    .then(m => { 
                        setData(d => ({...d, meta: m})); 
                    })
                    .catch(e => { console.error(e); log('ERROR: FAILED TO FETCH METADATA'); });
                setTimeout(() => lucide.createIcons(), 100);
            }, []);

            // Helper to determine best location string
            const getLocationDisplay = () => {
                const { city, region } = data.meta;
                if (city && city !== 'Unknown City') return city;
                if (region) return region;
                return 'Unknown Location';
            };

            const runTest = async () => {
                if(status === 'RUNNING') return;
                setStatus('RUNNING');
                setData(d => ({...d, down: 0, up: 0, ping: 0, jitter: 0, loss: 0}));
                log('TEST INITIATED...');

                try {
                    // 1. PING & PACKET LOSS
                    log('MEASURING LATENCY & LOSS...');
                    let pings = [];
                    let failedPings = 0;
                    for(let i=0; i<10; i++) {
                        const s = performance.now();
                        try {
                            const res = await fetch('/api/ping');
                            if (!res.ok) throw new Error('Ping failed');
                            pings.push(performance.now() - s);
                        } catch (e) { failedPings++; }
                    }
                    
                    const loss = (failedPings / 10) * 100;
                    const minPing = pings.length > 0 ? Math.min(...pings) : 0;
                    const jitter = pings.length > 1 ? Math.abs(pings[0] - pings[pings.length-1]) : 0;
                    setData(d => ({...d, ping: minPing, jitter, loss}));

                    // 2. DOWNLOAD
                    log('DOWNLOADING...');
                    const dlStart = performance.now();
                    let dlBytes = 0;
                    const dlDuration = 10000;
                    
                    while(performance.now() - dlStart < dlDuration) {
                        try {
                            const res = await fetch(`/api/down?bytes=${10 * 1024 * 1024}`);
                            const reader = res.body.getReader();
                            while(true) {
                                const {done, value} = await reader.read();
                                if(done) break;
                                dlBytes += value.length;
                                const elapsed = (performance.now() - dlStart) / 1000;
                                if (elapsed > 0) setData(d => ({...d, down: (dlBytes * 8) / (elapsed * 1000 * 1000)}));
                            }
                        } catch (e) {}
                    }

                    // 3. UPLOAD
                    log('UPLOADING...');
                    const ulStart = performance.now();
                    let ulBytes = 0;
                    const ulDuration = 10000;
                    const chunk = new Uint8Array(1024 * 1024); 
                    
                    while(performance.now() - ulStart < ulDuration) {
                        try {
                            await fetch('/api/up', { method: 'POST', body: chunk });
                            ulBytes += chunk.length;
                            const elapsed = (performance.now() - ulStart) / 1000;
                            if (elapsed > 0) setData(d => ({...d, up: (ulBytes * 8) / (elapsed * 1000 * 1000)}));
                        } catch (e) {}
                    }

                    setStatus('COMPLETE');
                    log('TEST COMPLETE');
                    log('--------------------------------');
                    log(`RESULTS FOR ${data.meta.ip}`);
                    log(`PROVIDER: ${data.meta.isp} (AS${data.meta.asn})`);
                    log(`LOCATION: ${getLocationDisplay()}, ${data.meta.country}`);
                    log(`SERVER:   ${data.meta.colo} (${getColoRegion(data.meta.colo)})`);
                    log(`DOWN:     ${((dlBytes * 8) / (dlDuration/1000 * 1000 * 1000)).toFixed(2)} Mbps`);
                    log(`UP:       ${((ulBytes * 8) / (ulDuration/1000 * 1000 * 1000)).toFixed(2)} Mbps`);
                    log(`PING:     ${minPing.toFixed(0)} ms`);
                    log(`JITTER:   ${jitter.toFixed(0)} ms`);
                    log(`LOSS:     ${loss.toFixed(1)}%`);
                    log('--------------------------------');

                } catch (err) {
                    console.error(err);
                    log('CRITICAL ERROR OCCURRED');
                    setStatus('IDLE');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 max-w-6xl mx-auto w-full">
                    
                    <header className="w-full border-b border-slate-200 pb-4 mb-8 flex justify-between items-end">
                        <div>
                            <h1 className="text-4xl font-bold text-slate-800 tracking-tighter">
                                KSEC <span className="text-emerald-600">SPEED TEST</span>
                            </h1>
                            <p className="text-xs text-slate-400 tracking-[0.3em] uppercase mt-1">
                                High Performance Network Analysis
                            </p>
                        </div>
                        <div className="text-right hidden sm:block">
                             <div className="flex items-center justify-end gap-2 text-xl font-bold text-slate-800">
                                {getFlag(data.meta.country)} {data.meta.country}
                             </div>
                             <div className="flex flex-col items-end">
                                 <a href={`https://radar.cloudflare.com/ip/${data.meta.ip}`} target="_blank" rel="noreferrer" className="flex items-center text-xs font-mono text-slate-500 font-bold text-blue-600 underline hover:text-blue-800 transition-colors">
                                    {data.meta.ip}
                                    <ExternalIcon />
                                 </a>
                                 <div className="text-[10px] font-mono text-slate-400 uppercase tracking-widest">{getIpVersion(data.meta.ip)}</div>
                             </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full mb-6">
                        <Gauge value={data.down} label="Download Speed" unit="Mbps" color="cyan" />
                        <Gauge value={data.up} label="Upload Speed" unit="Mbps" color="emerald" />
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 w-full mb-6">
                        <StatBox 
                            icon={<i data-lucide="activity" className="w-4 h-4 text-emerald-600"></i>}
                            label="Quality"
                            value={`${data.ping.toFixed(0)} ms`}
                            subValue={`Jitter: ${data.jitter.toFixed(0)} ms`}
                            extraValue={`Loss: ${data.loss.toFixed(1)}%`}
                        />
                         <StatBox 
                            icon={<i data-lucide="network" className="w-4 h-4 text-emerald-600"></i>}
                            label="Provider"
                            value={data.meta.isp}
                            subValue={
                                <span className="flex items-center gap-1">
                                    ASN: <a href={`https://radar.cloudflare.com/as${data.meta.asn}`} target="_blank" rel="noreferrer" className="flex items-center text-blue-600 underline hover:text-blue-800">
                                        AS{data.meta.asn}
                                        <ExternalIcon />
                                    </a>
                                </span>
                            } 
                        />
                         <StatBox 
                            icon={<i data-lucide="map-pin" className="w-4 h-4 text-emerald-600"></i>}
                            label="Location"
                            value={getLocationDisplay()}
                            subValue={`${getFlag(data.meta.country)} ${data.meta.country}`}
                        />
                         <StatBox 
                            icon={<i data-lucide="server" className="w-4 h-4 text-emerald-600"></i>}
                            label="Test Server"
                            value={data.meta.colo}
                            subValue={getColoRegion(data.meta.colo)}
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-8">
                        <button 
                            onClick={runTest} 
                            disabled={status === 'RUNNING'} 
                            className={`
                                md:col-span-1 tech-border py-4 font-bold tracking-widest uppercase transition-all duration-300 rounded-sm
                                ${status === 'RUNNING' 
                                    ? 'bg-slate-100 text-slate-400 cursor-not-allowed' 
                                    : 'bg-emerald-600 text-white hover:bg-emerald-700 shadow-lg hover:shadow-emerald-200'}
                            `}
                        >
                            {status === 'RUNNING' ? 'Running Analysis...' : 'Start Test'}
                        </button>
                        
                        <div className="md:col-span-2 tech-border bg-slate-50 p-3 font-mono text-xs flex flex-col justify-end h-48 rounded-sm border-slate-200 overflow-hidden">
                            <div className="overflow-y-auto flex flex-col-reverse h-full scrollbar-thin scrollbar-thumb-slate-200">
                                {logs.map((l, i) => (
                                    <div key={i} className="text-slate-600 mb-1 border-l-2 border-transparent pl-2 hover:border-emerald-300 transition-colors shrink-0 whitespace-pre-wrap">
                                        {l}
                                    </div>
                                )).reverse()}
                            </div>
                        </div>
                    </div>

                    {/* BGP Safety Section */}
                    <div className="w-full tech-border bg-white p-4 mb-8 flex items-center justify-between rounded-sm">
                        <div>
                            <h3 className="text-lg font-bold text-slate-800">Is BGP safe yet?</h3>
                            <p className="text-xs text-slate-500">Check if your ISP is implementing BGP safely with RPKI</p>
                        </div>
                        <a href="https://isbgpsafeyet.com/" target="_blank" rel="noreferrer" className="flex items-center text-sm font-bold text-blue-600 underline hover:text-blue-800">
                            isbgpsafeyet.com
                            <ExternalIcon />
                        </a>
                    </div>
                    
                    <footer className="mt-8 text-center text-xs text-slate-400 uppercase tracking-widest hover:text-emerald-600 transition-colors">
                        <a href="https://github.com/kaerez/speedtest/" target="_blank" rel="noopener noreferrer">
                            GitHub Repository & Licensing
                        </a>
                    </footer>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
